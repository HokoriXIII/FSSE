	<html>
    <head>
        <title>FalloutShelter save editor</title>
        <script src="ec.js"></script>
    </head>
    <body style="font-family: 'Kristen ITC'; background-color: #eeeeee;">
		<div id="cont" style="margin-left: auto; margin-right: auto; width: 750px; border: 1px solid #dddddd; padding: 15px;">
			<h3>Decrypt vault:</h3>
			<input type="file" id="file-input" />
			<br>
			<h3>Encrypt vault:</h3>
			<input type="file" id="file-input2" />
			
			<script type="text/javascript">
			function decodeVault(data, filename){
				var cipherBits = sjcl.codec.base64.toBits(data);
				var prp = new sjcl.cipher.aes(key);
				var plainBits = sjcl.mode.cbc.decrypt(prp, cipherBits, iv);
				var jsonStr = sjcl.codec.utf8String.fromBits(plainBits);
				var textFile = new Blob([jsonStr], {
					type: 'application/json'
				});			
				invokeSaveAsDialog(textFile, filename);
			}
			
			function encodeVault(data, filename){
				var obj = JSON.parse(data);
				var json_text = JSON.stringify(obj);
				var plainBits = sjcl.codec.utf8String.toBits(json_text);
				var prp = new sjcl.cipher.aes(key);
				var cipherBits = sjcl.mode.cbc.encrypt(prp, plainBits, iv);
				var base64Str = sjcl.codec.base64.fromBits(cipherBits);
				var textFile = new Blob([base64Str], {
					type: 'text/plain'
				});			
				invokeSaveAsDialog(textFile, filename);
			}
			
			function invokeSaveAsDialog(file, fileName) {
				var fileExtension = file.type.split('/')[1];

				if (fileName && fileName.indexOf('.') !== -1) {
					var splitted = fileName.split('.');
					fileName = splitted[0];
					fileExtension = splitted[1];
				}

				var fileFullName = (fileName || (Math.round(Math.random() * 9999999999) + 888888888)) + '.' + fileExtension;

				if (typeof navigator.msSaveOrOpenBlob !== 'undefined') {
					return navigator.msSaveOrOpenBlob(file, fileFullName);
				} else if (typeof navigator.msSaveBlob !== 'undefined') {
					return navigator.msSaveBlob(file, fileFullName);
				}

				var hyperlink = document.createElement('a');
				hyperlink.href = URL.createObjectURL(file);
				hyperlink.target = '_blank';
				hyperlink.download = fileFullName;

				if (!!navigator.mozGetUserMedia) {
					hyperlink.onclick = function() {
						(document.body || document.documentElement).removeChild(hyperlink);
					};
					(document.body || document.documentElement).appendChild(hyperlink);
				}

				var evt = new MouseEvent('click', {
					view: window,
					bubbles: true,
					cancelable: true
				});

				hyperlink.dispatchEvent(evt);

				if (!navigator.mozGetUserMedia) {
					URL.revokeObjectURL(hyperlink.href);
				}
			}
			
			var _fname;
			function readSingleFile(e) {
				var file = e.target.files[0];
				if (!file) {
					return;
				}
				var fname = file.name;
				var ar = fname.split('.');
				fname = "";
				for(var x=0;x<ar.length-1;x++){
				fname += ar[x] + ".";
				}
				_fname = fname + "json";
				var reader = new FileReader();
				reader.onload = function(e) {
					var contents = e.target.result;
					decodeVault(e.target.result, _fname);
				};
				reader.readAsText(file);
			}
			
			function readSingleFile2(e) {
				var file = e.target.files[0];
				if (!file) {
					return;
				}
				var fname = file.name;
				var ar = fname.split('.');
				fname = "";
				for(var x=0;x<ar.length-1;x++){
				fname += ar[x] + ".";
				}
				_fname = fname + "sav";
				var reader = new FileReader();
				reader.onload = function(e) {
					var contents = e.target.result;
					encodeVault(e.target.result, _fname);
				};
				reader.readAsText(file);
			}

			document.getElementById('file-input').addEventListener('change', readSingleFile, false);
			document.getElementById('file-input2').addEventListener('change', readSingleFile2, false);
			</script>
			<br>
			<br>
			<a href="index.html">Back</a>
			<br>
			<br>
			<a>Encryption/decryption script made by: <a href="https://github.com/tomisarobot">tomisarobot</a></a>
		</div>
    </body>
</html>
